<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Toolbox (Pages + Worker + KV)</title>
  <style>
    :root{
      --bg:#0b1020; --card:rgba(255,255,255,.08); --line:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.62);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Microsoft YaHei",Arial}
    .top{position:sticky;top:0;z-index:9;background:rgba(10,14,30,.75);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .topin{max-width:1200px;margin:0 auto;padding:12px 16px;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .brand{font-weight:900;display:flex;align-items:center;gap:10px}
    .dot{width:10px;height:10px;border-radius:999px;background:#5aa0ff;box-shadow:0 0 0 6px rgba(90,160,255,.16)}
    .right{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input,textarea{border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--text);border-radius:12px;padding:10px 12px;outline:none}
    .btn{border:1px solid var(--line);background:rgba(255,255,255,.08);color:var(--text);border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:800}
    .btn:hover{background:rgba(255,255,255,.12)}
    .btn.primary{border-color:rgba(90,160,255,.6);background:rgba(90,160,255,.18)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:12px}
    @media(max-width:980px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:640px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--line);background:var(--card);border-radius:16px;padding:12px;cursor:pointer}
    .name{font-weight:900}
    .desc{color:var(--muted);font-size:13px;margin-top:6px;line-height:1.5}
    .meta{margin-top:10px;color:var(--muted);font-size:12px;word-break:break-all}
    .panel{margin-top:16px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.05);border-radius:16px;padding:12px;display:none}
    .panel.active{display:block}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:8px 0}
    .viewer{position:fixed;inset:0;display:none;background:rgba(0,0,0,.55);backdrop-filter:blur(8px);padding:16px;z-index:50}
    .viewer.active{display:block}
    .vp{max-width:1200px;margin:0 auto;height:calc(100vh - 32px);border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,.18);background:rgba(10,14,30,.85);display:flex;flex-direction:column}
    .vh{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.14)}
    iframe{flex:1;border:none;background:#fff}
    .small{font-size:12px;color:var(--muted)}
    .err{white-space:pre-wrap;color:#ff9aa8;font-size:12px;margin-top:8px}
  </style>
</head>
<body>
  <div class="top">
    <div class="topin">
      <div class="brand"><span class="dot"></span> Toolbox <span class="small" id="count"></span></div>
      <div class="right">
        <input id="q" placeholder="搜索：名称/描述/URL…" />
        <button class="btn" id="reload">刷新</button>
        <button class="btn primary" id="toggleAdmin">管理</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="small">数据源：<code>/api/manifest</code>（Worker + KV）。编辑后点“保存到云端”，其他人刷新即同步。</div>

    <div class="panel" id="adminPanel">
      <div class="row">
        <input id="token" placeholder="Admin Token（仅你自己知道）" style="width:min(520px,100%)" />
        <button class="btn" id="saveToken">保存 Token</button>
        <span class="small">Token 只保存在你浏览器 localStorage。</span>
      </div>

      <div class="row">
        <button class="btn primary" id="add">+ 新增一条</button>
        <button class="btn" id="exportJson">导出 JSON</button>
        <button class="btn primary" id="saveCloud">保存到云端（KV）</button>
      </div>

      <div class="row" style="align-items:flex-start">
        <textarea id="editor" placeholder="manifest JSON（数组）" style="width:100%;min-height:220px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace"></textarea>
      </div>

      <div class="err" id="adminErr"></div>
    </div>

    <div class="grid" id="grid"></div>
    <div class="err" id="err"></div>
  </div>

  <div class="viewer" id="viewer">
    <div class="vp">
      <div class="vh">
        <div>
          <div style="font-weight:900" id="vname">预览</div>
          <div class="small" id="vmeta">—</div>
        </div>
        <div class="row">
          <a class="btn" id="openNew" target="_blank" rel="noopener">↗ 新标签</a>
          <button class="btn" id="close">关闭</button>
        </div>
      </div>
      <iframe id="frame" sandbox="allow-scripts allow-forms allow-same-origin allow-popups"></iframe>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const API = "/api/manifest"; // Worker 路由

    let ALL = [];
    let current = null;

    function normalize(list){
      return (Array.isArray(list)?list:[]).map((t,i)=>({
        id: t.id ?? String(i+1),
        name: t.name ?? "未命名",
        desc: t.desc ?? "",
        url: t.url ?? "",
        tag: t.tag ?? "",
        updatedAt: t.updatedAt ?? null
      })).filter(x=>x.url);
    }

    function render(list){
      $("grid").innerHTML = "";
      $("count").textContent = list.length ? `· ${list.length} 个` : "";
      list.forEach(t=>{
        const d = document.createElement("div");
        d.className = "card";
        d.innerHTML = `
          <div class="name">${escapeHtml(t.name)}</div>
          <div class="desc">${escapeHtml(t.desc)}</div>
          <div class="meta">${escapeHtml(t.url)}</div>
        `;
        d.onclick = ()=>openTool(t);
        $("grid").appendChild(d);
      });
    }

    function escapeHtml(s){
      return String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    function applyFilter(){
      const q = $("q").value.trim().toLowerCase();
      if(!q) return render(ALL);
      const r = ALL.filter(t => (t.name+" "+t.desc+" "+t.url+" "+(t.tag||"")).toLowerCase().includes(q));
      render(r);
    }

    async function load(){
      $("err").textContent = "";
      try{
        const res = await fetch(API, { cache:"no-store" });
        if(!res.ok) throw new Error("GET /api/manifest 失败: "+res.status+" "+res.statusText);
        const json = await res.json();
        ALL = normalize(json.items ?? json); // 兼容两种格式
        render(ALL);
        // 同步到编辑器
        $("editor").value = JSON.stringify(ALL, null, 2);
      }catch(e){
        $("err").textContent = String(e);
        ALL = [];
        render([]);
      }
    }

    function openTool(t){
      current = t;
      $("viewer").classList.add("active");
      $("vname").textContent = t.name;
      $("vmeta").textContent = t.desc || t.url;
      $("frame").src = t.url;
      $("openNew").href = t.url;
    }

    function closeViewer(){
      $("viewer").classList.remove("active");
      $("frame").src = "about:blank";
      current = null;
    }

    $("close").onclick = closeViewer;
    $("viewer").onclick = (e)=>{ if(e.target === $("viewer")) closeViewer(); };
    window.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeViewer(); });

    $("q").addEventListener("input", applyFilter);
    $("reload").onclick = load;

    // Admin
    $("toggleAdmin").onclick = ()=>{
      $("adminPanel").classList.toggle("active");
      $("adminErr").textContent = "";
    };

    // Token local save
    const TOKEN_KEY = "toolbox_admin_token";
    $("token").value = localStorage.getItem(TOKEN_KEY) || "";
    $("saveToken").onclick = ()=>{
      localStorage.setItem(TOKEN_KEY, $("token").value.trim());
      alert("Token 已保存到本机浏览器。");
    };

    $("add").onclick = ()=>{
      const now = new Date().toISOString();
      const item = { id: "new_"+Date.now(), name:"New Tool", desc:"", url:"/tools/your-tool.html", tag:"", updatedAt: now };
      const arr = parseEditorOrThrow();
      arr.unshift(item);
      $("editor").value = JSON.stringify(arr, null, 2);
    };

    $("exportJson").onclick = ()=>{
      try{
        const arr = parseEditorOrThrow();
        const blob = new Blob([JSON.stringify(arr,null,2)], {type:"application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "manifest.json";
        a.click();
        URL.revokeObjectURL(a.href);
      }catch(e){
        $("adminErr").textContent = String(e);
      }
    };

    function parseEditorOrThrow(){
      const txt = $("editor").value.trim();
      const arr = JSON.parse(txt);
      if(!Array.isArray(arr)) throw new Error("编辑器内容必须是 JSON 数组");
      return normalize(arr);
    }

    $("saveCloud").onclick = async ()=>{
      $("adminErr").textContent = "";
      try{
        const token = ($("token").value || localStorage.getItem(TOKEN_KEY) || "").trim();
        if(!token) throw new Error("请先填写 Admin Token");
        const items = parseEditorOrThrow();
        const res = await fetch(API, {
          method: "PUT",
          headers: {
            "content-type":"application/json",
            "authorization":"Bearer "+token
          },
          body: JSON.stringify({ items })
        });
        const text = await res.text();
        if(!res.ok) throw new Error("PUT /api/manifest 失败: "+res.status+" "+res.statusText+"\n"+text);
        await load();
        alert("已保存到云端（KV）。");
      }catch(e){
        $("adminErr").textContent = String(e);
      }
    };

    load();
  </script>
</body>
</html>
