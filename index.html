<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avalon DIY OS</title>
<script>
    // --- æ–°çš„åç«¯é€»è¾‘ (Fetch Cloudflare Functions) ---

    // 1. è·å–å·¥å…·åˆ—è¡¨
    async function getTools() {
        try {
            // è¯·æ±‚æˆ‘ä»¬åˆšæ‰å†™çš„ functions/api/tools.js
            const res = await fetch('/api/tools');
            if (!res.ok) throw new Error('ç½‘ç»œé”™è¯¯');
            return await res.json();
        } catch (e) {
            console.error(e);
            return [];
        }
    }

    // 2. ä¿å­˜å·¥å…·
    async function saveToolToCloud(name, icon, code) {
        try {
            const res = await fetch('/api/tools', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, icon, code })
            });
            return res.ok;
        } catch (e) {
            alert('ä¿å­˜å¤±è´¥: ' + e.message);
            return false;
        }
    }

    // 3. åˆ é™¤å·¥å…·
    async function deleteToolFromCloud(id) {
        try {
            const res = await fetch('/api/delete', {
                method: 'POST', // ä¸ºäº†ç®€å•ï¼Œè¿™é‡Œç”¨ POST ä¼ é€’ ID
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id })
            });
            return res.ok;
        } catch (e) {
            alert('åˆ é™¤å¤±è´¥');
            return false;
        }
    }

    // ... å…¶ä½™æ¸²æŸ“ä»£ç  (renderMenu, renderInstalledList) ä¿æŒä¸å˜ ...
    // ... åªæ˜¯æŠŠä¹‹å‰çš„ supabase è°ƒç”¨å…¨æ¢æˆä¸Šé¢çš„å‡½æ•°å³å¯ ...
</script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-highlight: rgba(255, 255, 255, 0.2);
            --text-main: #ffffff;
            --text-sub: rgba(255, 255, 255, 0.6);
            --accent-glow: 0 0 20px rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Inter', sans-serif;
            height: 100vh; overflow: hidden;
            color: var(--text-main);
            /* æ¨¡æ‹Ÿå›¾ç‰‡ä¸­çš„ç²‰è‰²æµä½“èƒŒæ™¯ */
            background: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
        }

        /* èƒŒæ™¯é®ç½©ï¼Œå¢åŠ æ–‡å­—å¯è¯»æ€§ */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(85, 45, 45, 0.2); /* å¾®å¾®çš„æš–è‰²é®ç½© */
            backdrop-filter: blur(0px); /* å¦‚æœèƒŒæ™¯å›¾å¤ªæ¸…æ™°å¯ä»¥åŠ ä¸€ç‚¹æ¨¡ç³Š */
        }

        /* --- å³ä¸Šè§’åå°æŒ‰é’® --- */
        .admin-trigger {
            position: absolute; top: 30px; right: 30px;
            width: 40px; height: 40px;
            border-radius: 50%;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: 0.3s;
            z-index: 2000;
        }
        .admin-trigger:hover {
            background: var(--glass-highlight);
            transform: rotate(90deg);
        }

        /* --- ä¸­å¿ƒä¸»èœå• (Avalon Card) --- */
        .center-stage {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 360px;
            z-index: 100;
            animation: fadeInUpscale 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .glass-card {
            background: rgba(20, 20, 20, 0.3); /* æ·±è‰²ç£¨ç ‚åº•ä»¥çªæ˜¾è´¨æ„Ÿ */
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 30px 20px;
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .app-title {
            font-size: 20px; font-weight: 500; letter-spacing: 0.5px;
            margin-bottom: 25px;
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .app-title i { opacity: 0.7; font-size: 16px; }

        .menu-list { display: flex; flex-direction: column; gap: 12px; }

        .menu-btn {
            background: linear-gradient(90deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid var(--glass-border);
            padding: 16px;
            border-radius: 16px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            position: relative; overflow: hidden;
        }
        
        .menu-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.4);
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(255,255,255,0.1);
        }

        .menu-btn i { width: 20px; }

        /* --- æµ®åŠ¨çª—å£ (ç”Ÿæˆçš„å·¥å…·) --- */
        .window-container { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; z-index: 500; }
        
        .float-window {
            position: absolute;
            pointer-events: auto;
            width: 600px;
            min-height: 300px;
            background: rgba(30, 30, 30, 0.65);
            backdrop-filter: blur(30px) saturate(150%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.4);
            display: flex; flex-direction: column;
            overflow: hidden;
            animation: popIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        .win-header {
            padding: 15px 20px;
            background: rgba(255,255,255,0.03);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex; justify-content: space-between; align-items: center;
            cursor: grab;
        }
        .win-header:active { cursor: grabbing; }
        .win-title { font-size: 14px; font-weight: 500; opacity: 0.9; }
        .win-controls i { cursor: pointer; opacity: 0.5; transition: 0.2s; padding: 4px; }
        .win-controls i:hover { opacity: 1; color: #ff7675; }

        .win-body { padding: 20px; flex: 1; overflow-y: auto; max-height: 70vh; color: #eee; }

        /* --- åå°ç®¡ç† Modal --- */
        .modal-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 3000; display: none; align-items: center; justify-content: center;
        }
        .admin-panel {
            width: 500px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 50px 100px rgba(0,0,0,0.5);
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; color: #aaa; margin-bottom: 5px; }
        .form-input {
            width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; font-family: 'Inter', sans-serif;
        }
        textarea.form-input { height: 150px; font-family: monospace; font-size: 12px; resize: vertical; }
        .btn-primary {
            width: 100%; padding: 12px; background: white; color: black; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-top: 10px;
        }
        .btn-primary:hover { opacity: 0.9; }
        .btn-delete { background: #ff4757; color: white; margin-top: 10px; padding: 8px; border:none; border-radius:4px; cursor: pointer; width: 100%; }

        /* åŠ¨ç”» */
        @keyframes fadeInUpscale { from { opacity: 0; transform: translate(-50%, -40%) scale(0.95); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        /* å·¥å…·å†…éƒ¨é€šç”¨æ ·å¼ (ç”¨æˆ·æ³¨å…¥çš„ä»£ç å¯ä»¥ä½¿ç”¨) */
        .tool-btn { padding: 10px 20px; background: #6c5ce7; color: white; border: none; border-radius: 8px; cursor: pointer; }
        .tool-input { padding: 10px; border-radius: 6px; border: 1px solid #444; background: #222; color: white; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>

    <div class="overlay"></div>

    <div class="admin-trigger" onclick="openAdmin()" title="æ·»åŠ æ–°ç»„ä»¶">
        <i class="fas fa-plus"></i>
    </div>

    <div class="center-stage">
        <div class="glass-card">
            <div class="app-title">
                HUBERYâ„¢ <span style="font-size:12px; opacity:0.5;">PRO</span>
            </div>
            
            <div class="menu-list" id="menuList">
                </div>
        </div>
    </div>

    <div class="window-container" id="windowLayer"></div>

    <div class="modal-overlay" id="adminModal">
        <div class="admin-panel">
            <h3 style="margin-top:0">é…ç½®æ–°ç»„ä»¶</h3>
            <div class="form-group">
                <label>ç»„ä»¶åç§°</label>
                <input type="text" id="toolName" class="form-input" placeholder="ä¾‹å¦‚ï¼šè´´çº¸ç”Ÿæˆå™¨">
            </div>
            <div class="form-group">
                <label>å›¾æ ‡ä»£ç  (FontAwesome)</label>
                <input type="text" id="toolIcon" class="form-input" placeholder="fa-magic">
            </div>
            <div class="form-group">
                <label>HTML ä»£ç  (åŒ…å« style/script)</label>
                <textarea id="toolCode" class="form-input" placeholder="<div>æˆ‘çš„å·¥å…·å†…å®¹...</div><script>...</script>"></textarea>
            </div>
            <button class="btn-primary" onclick="saveTool()">ä¿å­˜å¹¶æ·»åŠ åˆ°æ¡Œé¢</button>
            <button style="background:transparent; color:#aaa; border:none; width:100%; margin-top:10px; cursor:pointer;" onclick="closeAdmin()">å–æ¶ˆ</button>
            
            <hr style="border-color:#333; margin: 20px 0;">
            <label style="color:#aaa; font-size:12px;">å·²å®‰è£…ç»„ä»¶ç®¡ç†ï¼š</label>
            <div id="installedList" style="margin-top:10px; max-height:100px; overflow-y:auto;"></div>
        </div>
    </div>

<script>
    // --- 1. æ ¸å¿ƒæ•°æ®ç®¡ç† (LocalStorage) ---
    const DB_KEY = 'avalon_tools_v1';
    

    function getTools() {
        const stored = localStorage.getItem(DB_KEY);
        return stored ? JSON.parse(stored) : defaultTools;
    }

    function saveToolsToStorage(tools) {
        localStorage.setItem(DB_KEY, JSON.stringify(tools));
        renderMenu();
        renderInstalledList();
    }

    // --- 2. æ¸²æŸ“å¼•æ“ ---
    function renderMenu() {
        const list = document.getElementById('menuList');
        const tools = getTools();
        list.innerHTML = '';

        tools.forEach(tool => {
            const btn = document.createElement('div');
            btn.className = 'menu-btn';
            btn.innerHTML = `<i class="fas ${tool.icon}"></i> ${tool.name}`;
            btn.onclick = () => openWindow(tool);
            list.appendChild(btn);
        });
        
        // æ·»åŠ ä¸€ä¸ª remix æŒ‰é’® (è§†è§‰è£…é¥°)
        const remix = document.createElement('div');
        remix.innerHTML = '<span style="font-size:12px; opacity:0.5; margin-top:10px; cursor:pointer;"><i class="fas fa-random"></i> ğŸ’« è¡Œå·±æ‰€çˆ± çˆ±å·±æ‰€è¡Œ ğŸ’«</span>';
        list.appendChild(remix);
    }

    // --- 3. çª—å£ç®¡ç†å™¨ ---
    let zIndexCounter = 1000;

    function openWindow(tool) {
        // æ£€æŸ¥æ˜¯å¦å·²æ‰“å¼€
        if(document.getElementById('win-'+tool.id)) return;

        const win = document.createElement('div');
        win.className = 'float-window';
        win.id = 'win-' + tool.id;
        win.style.zIndex = ++zIndexCounter;
        win.style.top = '15%';
        win.style.left = '20%';

        // ç‚¹å‡»ç½®é¡¶
        win.addEventListener('mousedown', () => win.style.zIndex = ++zIndexCounter);

        // æ³¨å…¥å†…å®¹ (HTML + JS)
        // æ³¨æ„ï¼šscriptæ ‡ç­¾åœ¨innerHTMLä¸­ä¸ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
        win.innerHTML = `
            <div class="win-header">
                <span class="win-title"><i class="fas ${tool.icon}"></i> ${tool.name}</span>
                <div class="win-controls">
                    <i class="fas fa-times" onclick="document.getElementById('${win.id}').remove()"></i>
                </div>
            </div>
            <div class="win-body" id="body-${tool.id}">
                ${tool.code}
            </div>
        `;

        document.getElementById('windowLayer').appendChild(win);
        
        // é‡æ–°æ¿€æ´» script
        const scripts = win.querySelectorAll('script');
        scripts.forEach(oldScript => {
            const newScript = document.createElement('script');
            Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
            newScript.appendChild(document.createTextNode(oldScript.innerHTML));
            oldScript.parentNode.replaceChild(newScript, oldScript);
        });

        initDraggable(win);
    }

    function initDraggable(el) {
        const header = el.querySelector('.win-header');
        let isDragging = false, startX, startY, initLeft, initTop;

        header.addEventListener('mousedown', e => {
            isDragging = true;
            startX = e.clientX; startY = e.clientY;
            initLeft = el.offsetLeft; initTop = el.offsetTop;
            header.style.cursor = 'grabbing';
        });

        window.addEventListener('mousemove', e => {
            if(!isDragging) return;
            e.preventDefault();
            el.style.left = (initLeft + (e.clientX - startX)) + 'px';
            el.style.top = (initTop + (e.clientY - startY)) + 'px';
        });

        window.addEventListener('mouseup', () => { isDragging = false; header.style.cursor = 'grab'; });
    }

    // --- 4. åå°é€»è¾‘ ---
    function openAdmin() {
        document.getElementById('adminModal').style.display = 'flex';
        renderInstalledList();
    }
    function closeAdmin() {
        document.getElementById('adminModal').style.display = 'none';
    }

    function saveTool() {
        const name = document.getElementById('toolName').value;
        const icon = document.getElementById('toolIcon').value || 'fa-cube';
        const code = document.getElementById('toolCode').value;

        if(!name || !code) return alert('è¯·å¡«å†™åç§°å’Œä»£ç ');

        const tools = getTools();
        const newTool = {
            id: 'tool_' + Date.now(),
            name: name,
            icon: icon,
            code: code
        };

        tools.push(newTool);
        saveToolsToStorage(tools);
        
        alert('ç»„ä»¶æ·»åŠ æˆåŠŸï¼');
        closeAdmin();
        // æ¸…ç©ºè¡¨å•
        document.getElementById('toolName').value = '';
        document.getElementById('toolCode').value = '';
    }

    function deleteTool(id) {
        if(!confirm('ç¡®å®šåˆ é™¤æ­¤ç»„ä»¶å—ï¼Ÿ')) return;
        let tools = getTools();
        tools = tools.filter(t => t.id !== id);
        saveToolsToStorage(tools);
    }

    function renderInstalledList() {
        const list = document.getElementById('installedList');
        const tools = getTools();
        list.innerHTML = '';
        tools.forEach(tool => {
            const div = document.createElement('div');
            div.style.cssText = "display:flex; justify-content:space-between; background:#222; padding:5px; margin-bottom:5px; border-radius:4px; font-size:12px; color:white;";
            div.innerHTML = `
                <span>${tool.name}</span>
                <span onclick="deleteTool('${tool.id}')" style="cursor:pointer; color:#ff4757;">[åˆ é™¤]</span>
            `;
            list.appendChild(div);
        });
    }

    // åˆå§‹åŒ–
    renderMenu();

</script>
</body>
</html>