<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HUBERY Words</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .stat-bar {
            height: 10px;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
        }
        .bar-chart-container {
            height: 150px;
            display: flex;
            align-items: flex-end;
            gap: 4px;
        }
        .bar-item {
            flex-grow: 1;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            position: relative;
        }
        .bar {
            width: 80%;
            background-color: #5a5de0; /* Indigo */
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
            transition: height 0.3s ease-out;
        }
        .bar-label {
            font-size: 0.75rem;
            color: #4b5563;
            margin-top: 4px;
        }
        .bar-count {
            position: absolute;
            top: -20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #1f2937;
        }
        /* éšè—å’Œæ˜¾ç¤ºå†…å®¹ */
        .collapsible {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .collapsible.active {
            max-height: 800px; 
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }
        .modal.show {
            display: flex;
        }
        /* æµå…‰èƒŒæ™¯åŠ¨ç”» */
        @keyframes shimmer {
           0% { background-position: 0% 50%; }
           100% { background-position: 200% 50%; }
       }
        .animate-shimmer {
        animation: shimmer 3s linear infinite; /* 3ç§’å¾ªç¯ä¸€æ¬¡ */
}
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

    <!-- é¡¶éƒ¨å¯¼èˆª/çŠ¶æ€æ  -->
    <div class="w-full max-w-2xl flex justify-between items-center mb-4 px-2">
        <div class="text-indigo-600 font-bold text-lg flex items-center">
             WordTracker <span class="text-xs bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded ml-2">HUBERY</span>
        </div>
        <div class="flex items-center space-x-3">
            <span id="userStatus" class="text-sm text-gray-500">ğŸ‘¤ é»˜è®¤é…ç½®</span>
            
            <!-- è®¾ç½®æŒ‰é’® -->
            <button id="settingsBtn" class="text-gray-500 hover:text-gray-700 transition" title="é…ç½® AI æ¥å£">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </button>
            
            <button id="authBtn" class="text-sm px-3 py-1 bg-white border border-gray-300 rounded hover:bg-gray-50 transition text-gray-700">
                åˆ‡æ¢ç”¨æˆ·
            </button>
            <button id="resetBtn" class="text-sm px-3 py-1 bg-red-50 text-red-600 border border-red-100 rounded hover:bg-red-100 transition" title="æ¸…ç©ºå½“å‰ç”¨æˆ·æ•°æ®">
                é‡ç½®
            </button>
        </div>
    </div>

    <div id="app" class="w-full max-w-2xl bg-white shadow-2xl rounded-xl p-6 md:p-8 space-y-6 relative">
        <h1 class="text-3xl font-bold text-center text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 via-purple-500 to-indigo-600 animate-shimmer bg-[length:200%_auto]">
            â­å•è¯å¤è®°å½•æœ¬â­
        </h1>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯æ¦‚è§ˆ -->
        <div class="grid grid-cols-2 gap-4 bg-indigo-50 p-4 rounded-lg shadow-inner text-center">
            <div>
                <p class="text-sm text-indigo-600 font-medium">ç´¯è®¡å¤ä¹ æ¬¡æ•°</p>
                <p id="totalRepetitions" class="text-2xl font-bold text-indigo-800">0</p>
            </div>
            <div>
                <p class="text-sm text-green-600 font-medium">ç´¯è®¡å­¦ä¹ æ—¶é•¿ (åˆ†é’Ÿ)</p>
                <p id="totalStudyTime" class="text-2xl font-bold text-green-800">0</p>
            </div>
        </div>
        
        <!-- æ ¸å¿ƒè¾“å…¥åŒºåŸŸ -->
        <div class="space-y-4">
            <h2 class="text-xl font-semibold text-gray-700">è®°å½•æ‚¨çš„å¤ä¹ å•è¯</h2>
            <div class="flex space-x-2">
                <input type="text" id="wordInput" 
                       placeholder="è¾“å…¥æ‚¨åˆšåˆšå¤ä¹ çš„å•è¯"
                       class="flex-grow p-3 border-2 border-gray-300 rounded-lg text-lg focus:border-indigo-500 focus:ring focus:ring-indigo-200 transition duration-150"
                       autofocus>
                <button id="defineBtn"
                        class="px-3 py-3 bg-pink-500 text-white font-semibold rounded-lg shadow-lg hover:bg-pink-600 transition duration-150 flex items-center justify-center disabled:bg-gray-400"
                        title="è·å–å•è¯å®šä¹‰å’Œä¾‹å¥ (AI Powered)">
                    âœ¨ æŸ¥è¯
                </button>
            </div>
            <button id="recordBtn"
                    class="w-full py-3.5 bg-[#007AFF] text-white font-semibold rounded-2xl shadow-sm hover:opacity-90 active:scale-[0.98] active:opacity-80 transition-all duration-200 disabled:bg-gray-100 disabled:text-gray-400">
                è®°å½•
            </button>
        </div>
        
        <!-- AI å“åº”åŒºåŸŸ -->
        <div id="aiResponseArea" class="space-y-4">
             <div id="llmResponse" class="bg-white border border-gray-200 p-4 rounded-lg text-gray-700 hidden shadow-sm">
                <!-- AI è§£é‡Šå†…å®¹æ˜¾ç¤ºåŒº -->
             </div>
             <div class="flex justify-center">
                 <div id="aiLoader" class="hidden loader"></div>
             </div>
        </div>

        <!-- å­¦ä¹ æ€»ç»“æŒ‰é’® -->
        <button id="summaryBtn"
                class="w-full px-4 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-lg hover:bg-green-600 transition duration-150 flex items-center justify-center disabled:bg-gray-400">
            âœ¨ è·å–å­¦ä¹ æ€»ç»“ä¸å»ºè®®
        </button>


        <!-- å­¦ä¹ æ—¶é—´æ›²çº¿å›¾ -->
        <div class="bg-white p-4 rounded-lg shadow-md border border-gray-100">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">è¿‘ 7 å¤©å¤ä¹ æ¬¡æ•°æ›²çº¿</h2>
            <div id="timeCurveChart" class="bar-chart-container">
                <p class="text-gray-400 text-center w-full">åŠ è½½ä¸­...</p>
            </div>
        </div>

        <!-- å•è¯å¤ä¹ ç»Ÿè®¡ (å¯æŠ˜å ) -->
        <div class="bg-white p-4 rounded-lg shadow-md border border-gray-100">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold text-gray-700">
                    å•è¯å¤ä¹ ç»Ÿè®¡ (å…± <span id="uniqueWordCount">0</span> è¯)
                </h2>
                <button id="toggleHistoryBtn" 
                        class="text-indigo-600 hover:text-indigo-800 font-medium transition duration-150 flex items-center">
                    <span id="toggleText">å±•å¼€æŸ¥çœ‹</span>
                    <svg id="toggleIcon" class="w-5 h-5 ml-1 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
            </div>

            <!-- å¯æŠ˜å å†…å®¹ -->
            <div id="wordStatsCollapse" class="collapsible">
                <div class="py-2 border-t border-gray-200">
                    <div class="flex font-semibold text-gray-600 border-b pb-1">
                        <span class="w-1/2">å•è¯</span>
                        <span class="w-1/4 text-center">æ¬¡æ•°</span>
                        <span class="w-1/4 text-right">ä¸Šæ¬¡å¤ä¹ </span>
                    </div>
                    <ul id="wordStatsList" class="space-y-1 text-sm max-h-80 overflow-y-auto pt-2">
                        <li class="text-gray-500 text-center">åŠ è½½ç»Ÿè®¡æ•°æ®...</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- æ¶ˆæ¯åŒºåŸŸ -->
        <div id="message-box" class="p-3 text-center text-sm rounded-lg transition-all duration-300 hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 shadow-lg z-50"></div>
    </div>

    <!-- User Switch Modal -->
    <div id="authModal" class="modal">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm relative">
            <button class="close-modal-btn absolute top-3 right-3 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            
            <h2 class="text-2xl font-bold mb-6 text-center text-indigo-700">åˆ‡æ¢æœ¬åœ°é…ç½®</h2>
            
            <div class="space-y-4">
                <div class="bg-blue-50 p-3 rounded text-xs text-blue-800 border border-blue-200">
                    æç¤ºï¼šæ•°æ®ä»…ä¿å­˜åœ¨æ­¤æµè§ˆå™¨ä¸­ã€‚è¾“å…¥ä¸åŒçš„åå­—å¯ä»¥åˆ›å»ºä¸åŒçš„å­¦ä¹ è¿›åº¦æ¡£æ¡ˆã€‚
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç”¨æˆ·å / æ¡£æ¡ˆå</label>
                    <input type="text" id="authNameInput" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500 transition" placeholder="ä¾‹å¦‚: User1">
                </div>
                
                <button id="submitAuthBtn" class="w-full py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">
                    åˆ‡æ¢æ¡£æ¡ˆ
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal (New!) -->
    <div id="settingsModal" class="modal">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md relative">
            <button class="close-modal-btn absolute top-3 right-3 text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            
            <h2 class="text-xl font-bold mb-4 text-center text-gray-800">âš™ï¸ AI æ¥å£é…ç½®</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">AI æä¾›å•†</label>
                    <select id="apiProvider" class="w-full p-2 border rounded-lg bg-white">
                        <option value="gemini">Google Gemini</option>
                        <option value="openai">OpenAI å…¼å®¹ (DeepSeek/Kimi/ChatGPT)</option>
                    </select>
                </div>

                <!-- Gemini Specific -->
                <div id="geminiFields" class="api-fields space-y-3">
                    <p class="text-xs text-gray-500">ç›´æ¥è¿æ¥ Google çš„æœåŠ¡å™¨ã€‚</p>
                </div>

                <!-- OpenAI/Custom Specific -->
                <div id="openaiFields" class="api-fields space-y-3 hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">API Base URL (æ¥å£åœ°å€)</label>
                        <input type="text" id="apiBaseUrl" class="w-full p-2 border rounded-lg text-sm" placeholder="https://api.openai.com/v1">
                        <p class="text-xs text-gray-400 mt-1">ä¾‹å¦‚: https://api.deepseek.com/v1 æˆ– https://api.moonshot.cn/v1</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ¨¡å‹åç§° (Model Name)</label>
                        <input type="text" id="apiModelName" class="w-full p-2 border rounded-lg text-sm" placeholder="gpt-3.5-turbo">
                        <p class="text-xs text-gray-400 mt-1">ä¾‹å¦‚: deepseek-chat, moonshot-v1-8k</p>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">API Key (å¯†é’¥)</label>
                    <input type="password" id="apiKeyInput" class="w-full p-2 border rounded-lg" placeholder="sk-...">
                </div>

                <div class="pt-2">
                    <button id="saveSettingsBtn" class="w-full py-2 px-4 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition">
                        ä¿å­˜é…ç½®
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Logic -->
    <script>
        // =================================================================
        // 1. å…¨å±€é…ç½®ä¸çŠ¶æ€
        // =================================================================

        const STORAGE_PREFIX = "word_tracker_data_";
        const CONFIG_KEY = "word_tracker_api_config";

        // é»˜è®¤é…ç½®
        let apiConfig = {
            provider: 'gemini', // 'gemini' or 'openai'
            baseUrl: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent',
            modelName: 'gemini-2.5-flash-preview-09-2025',
            apiKey: ''
        };

        // æ•°æ®ç»“æ„
        const defaultData = {
            repetitions: [],
            stats: { totalRepetitions: 0, totalStudyTimeMinutes: 0, lastUpdated: 0 }
        };

        let currentProfile = "guest"; 
        let appData = JSON.parse(JSON.stringify(defaultData)); 
        let sessionTimer = null;

        // UI References
        const els = {
            messageBox: document.getElementById('message-box'),
            recordBtn: document.getElementById('recordBtn'),
            wordInput: document.getElementById('wordInput'),
            defineBtn: document.getElementById('defineBtn'),
            summaryBtn: document.getElementById('summaryBtn'),
            llmResponse: document.getElementById('llmResponse'),
            aiLoader: document.getElementById('aiLoader'),
            userStatus: document.getElementById('userStatus'),
            authBtn: document.getElementById('authBtn'),
            resetBtn: document.getElementById('resetBtn'),
            settingsBtn: document.getElementById('settingsBtn'),
            // Auth Modal
            authModal: document.getElementById('authModal'),
            authNameInput: document.getElementById('authNameInput'),
            submitAuthBtn: document.getElementById('submitAuthBtn'),
            // Settings Modal
            settingsModal: document.getElementById('settingsModal'),
            apiProvider: document.getElementById('apiProvider'),
            apiBaseUrl: document.getElementById('apiBaseUrl'),
            apiModelName: document.getElementById('apiModelName'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            saveSettingsBtn: document.getElementById('saveSettingsBtn'),
            geminiFields: document.getElementById('geminiFields'),
            openaiFields: document.getElementById('openaiFields'),
            // Stats
            totalRep: document.getElementById('totalRepetitions'),
            totalTime: document.getElementById('totalStudyTime'),
            chart: document.getElementById('timeCurveChart'),
            list: document.getElementById('wordStatsList'),
            uniqueCount: document.getElementById('uniqueWordCount'),
            toggleBtn: document.getElementById('toggleHistoryBtn'),
            collapse: document.getElementById('wordStatsCollapse'),
            toggleText: document.getElementById('toggleText'),
            toggleIcon: document.getElementById('toggleIcon')
        };

        // =================================================================
        // 2. æœ¬åœ°æ•°æ®ç®¡ç† (Local Storage)
        // =================================================================

        function loadConfig() {
            const stored = localStorage.getItem(CONFIG_KEY);
            if (stored) {
                apiConfig = JSON.parse(stored);
            }
        }

        function saveConfig() {
            localStorage.setItem(CONFIG_KEY, JSON.stringify(apiConfig));
            showMessage("API é…ç½®å·²ä¿å­˜", "success");
        }

        function loadData(profileName) {
            currentProfile = profileName || "guest";
            const key = STORAGE_PREFIX + currentProfile;
            const stored = localStorage.getItem(key);
            appData = stored ? JSON.parse(stored) : JSON.parse(JSON.stringify(defaultData));
            
            els.userStatus.textContent = `ğŸ‘¤ ${currentProfile}`;
            localStorage.setItem('wt_last_profile', currentProfile);
            updateUI();
        }

        function saveData() {
            localStorage.setItem(STORAGE_PREFIX + currentProfile, JSON.stringify(appData));
            updateUI();
        }

        function resetData() {
            if (confirm(`ç¡®å®šè¦æ¸…ç©ºç”¨æˆ· "${currentProfile}" çš„æ•°æ®å—ï¼Ÿ`)) {
                appData = JSON.parse(JSON.stringify(defaultData));
                saveData();
                showMessage("æ•°æ®å·²é‡ç½®", "info");
            }
        }

        // =================================================================
        // 3. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
        // =================================================================

        function updateUI() {
            els.totalRep.textContent = appData.stats.totalRepetitions;
            els.totalTime.textContent = appData.stats.totalStudyTimeMinutes;
            
            const reps = [...appData.repetitions].sort((a, b) => b.timestamp - a.timestamp);
            renderWordStatistics(reps);
            renderTimeCurve(reps);
        }

        function recordRepetition() {
            const word = els.wordInput.value.trim();
            if (!word) { showMessage("è¯·è¾“å…¥å•è¯", 'warning'); return; }

            appData.repetitions.push({ word, timestamp: Date.now() });
            appData.stats.totalRepetitions++;
            appData.stats.lastUpdated = Date.now();

            saveData();
            els.wordInput.value = ''; 
            els.wordInput.focus();
            showMessage(`"${word}" è®°å½•æˆåŠŸ!`, 'success');
        }

        function startSessionTimer() {
            if (sessionTimer) clearInterval(sessionTimer);
            sessionTimer = setInterval(() => {
                appData.stats.totalStudyTimeMinutes++;
                saveData();
            }, 60000); 
        }

        function renderWordStatistics(repetitions) {
            els.list.innerHTML = ''; 
            if (repetitions.length === 0) {
                els.list.innerHTML = '<li class="text-gray-500 text-center">æš‚æ— æ•°æ®</li>';
                els.uniqueCount.textContent = 0;
                return;
            }

            const aggregated = repetitions.reduce((acc, item) => {
                const w = item.word.toLowerCase(); 
                if (!acc[w]) acc[w] = { word: item.word, count: 0, lastTimestamp: 0 };
                acc[w].count++;
                if (item.timestamp > acc[w].lastTimestamp) acc[w].lastTimestamp = item.timestamp;
                return acc;
            }, {});

            const sorted = Object.values(aggregated).sort((a, b) => b.count - a.count);
            els.uniqueCount.textContent = sorted.length;

            sorted.forEach(stat => {
                const date = new Date(stat.lastTimestamp).toLocaleDateString('zh-CN', {month:'numeric', day:'numeric'});
                const li = document.createElement('li');
                li.className = 'flex items-center p-2 border-b border-gray-100 hover:bg-indigo-50 transition rounded';
                li.innerHTML = `
                    <span class="w-1/2 font-medium text-indigo-700">${stat.word}</span>
                    <span class="w-1/4 text-center font-bold text-gray-800 bg-gray-100 rounded-full text-xs py-1">${stat.count}æ¬¡</span>
                    <span class="w-1/4 text-right text-xs text-gray-400">${date}</span>
                `;
                els.list.appendChild(li);
            });
        }

        function renderTimeCurve(repetitions) {
            els.chart.innerHTML = ''; 
            const dayCounts = {};
            const dayLabels = [];
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let i = 6; i >= 0; i--) { 
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                const k = d.toISOString().split('T')[0];
                dayCounts[k] = 0;
                dayLabels.push(d.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' }));
            }

            repetitions.forEach(item => {
                const d = new Date(item.timestamp);
                d.setHours(0,0,0,0);
                const k = d.toISOString().split('T')[0];
                if (dayCounts[k] !== undefined) dayCounts[k]++;
            });

            const counts = Object.values(dayCounts);
            const max = Math.max(...counts, 1); 
            const sortedKeys = Object.keys(dayCounts).sort();

            sortedKeys.forEach((k, i) => {
                const count = dayCounts[k];
                const height = (count / max) * 90; 
                const div = document.createElement('div');
                div.className = 'bar-item';
                div.innerHTML = `
                    <div class="bar-count ${count > 0 ? '' : 'hidden'}">${count}</div>
                    <div class="bar" style="height: ${height}%; background-color: ${count > 0 ? '#6366f1' : '#e5e7eb'}"></div>
                    <div class="bar-label">${dayLabels[i]}</div>
                `;
                els.chart.appendChild(div);
            });
        }

        // =================================================================
        // 4. AI æ¥å£è°ƒç”¨é€»è¾‘ (é€šç”¨ç‰ˆ)
        // =================================================================

        // ç»Ÿä¸€çš„ LLM è°ƒç”¨å‡½æ•°
        async function callLLM(userQuery, systemPrompt) {
            if (!apiConfig.apiKey) {
                showMessage("è¯·å…ˆç‚¹å‡»å³ä¸Šè§’âš™ï¸é…ç½® API Key", "error");
                // è‡ªåŠ¨æ‰“å¼€è®¾ç½®
                openModal(els.settingsModal);
                throw new Error("No API Key");
            }

            if (apiConfig.provider === 'gemini') {
                return await callGemini(userQuery, systemPrompt);
            } else {
                return await callOpenAICompatible(userQuery, systemPrompt);
            }
        }

        // Google Gemini å®ç°
        async function callGemini(userQuery, systemPrompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiConfig.apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error(`Gemini Error: ${response.status}`);
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text;
        }

        // OpenAI å…¼å®¹å®ç° (DeepSeek, Kimi, Moonshot, LocalLLM)
        async function callOpenAICompatible(userQuery, systemPrompt) {
            const baseUrl = apiConfig.baseUrl.replace(/\/$/, ''); // å»æ‰æœ«å°¾æ–œæ 
            const url = `${baseUrl}/chat/completions`;
            
            const payload = {
                model: apiConfig.modelName,
                messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: userQuery }
                ],
                temperature: 0.7
            };

            const response = await fetch(url, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiConfig.apiKey}`
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const err = await response.text();
                throw new Error(`API Error ${response.status}: ${err}`);
            }
            const data = await response.json();
            return data.choices?.[0]?.message?.content;
        }
        
        // æŸ¥è¯åŠŸèƒ½
        async function getWordDefinitionAndExamples() {
            const word = els.wordInput.value.trim();
            if (!word) { showMessage("è¯·è¾“å…¥å•è¯", 'warning'); return; }
            
            setAiLoading(true);

            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è‹±è¯­è¯å…¸åŠ©æ‰‹ã€‚è¯·æä¾›å•è¯çš„ä»¥ä¸‹ä¿¡æ¯ï¼š
1. éŸ³æ ‡ (IPA)
2. è¯æ€§ (Part of Speech)
3. ç®€æ´çš„ä¸­æ–‡å®šä¹‰
4. ä¸¤ä¸ªæ¸…æ™°çš„è‹±æ–‡ä¾‹å¥

è¯·ä¸¥æ ¼ä½¿ç”¨ä»¥ä¸‹ Markdown æ ¼å¼è¿”å›ï¼ˆä¸è¦åŒ…å«å…¶ä»–æ–‡æœ¬ï¼‰ï¼š
**éŸ³æ ‡ï¼š** /ipa/
**è¯æ€§ï¼š** n. (æˆ– v. adj. ç­‰)
**å®šä¹‰ï¼š** ä¸­æ–‡å®šä¹‰æ–‡æœ¬
**ä¾‹å¥ï¼š**
- Example 1
- Example 2`;

            const userQuery = `è¯·è§£æå•è¯ "${word}"`;

            try {
                const text = await callLLM(userQuery, systemPrompt);
                
                // è§£æ Markdown
                let ipa = "", pos = "", def = "", examplesHtml = "";
                const lines = (text || "").split('\n');
                let inExamples = false;

                lines.forEach(line => {
                    if (line.includes('**éŸ³æ ‡ï¼š**')) ipa = line.replace('**éŸ³æ ‡ï¼š**', '').trim();
                    else if (line.includes('**è¯æ€§ï¼š**')) pos = line.replace('**è¯æ€§ï¼š**', '').trim();
                    else if (line.includes('**å®šä¹‰ï¼š**')) def = line.replace('**å®šä¹‰ï¼š**', '').trim();
                    else if (line.includes('**ä¾‹å¥ï¼š**')) inExamples = true;
                    else if (inExamples && line.trim().startsWith('-')) {
                        examplesHtml += `<li class="mb-1 text-gray-600">${line.replace('-', '').trim()}</li>`;
                    }
                });

                els.llmResponse.innerHTML = `
                    <div class="flex flex-col space-y-3">
                        <div class="flex items-baseline justify-between border-b pb-2">
                            <h3 class="text-2xl font-bold text-indigo-700">${word}</h3>
                            <span class="text-gray-500 font-mono bg-gray-100 px-2 py-1 rounded">${ipa}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="bg-indigo-100 text-indigo-800 text-xs font-semibold px-2.5 py-0.5 rounded">${pos}</span>
                            <p class="text-gray-800 font-medium">${def}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-100">
                            <p class="text-xs text-gray-400 font-bold mb-1 uppercase tracking-wider">ä¾‹å¥</p>
                            <ul class="list-disc list-inside text-sm">${examplesHtml}</ul>
                        </div>
                    </div>
                `;
                els.llmResponse.classList.remove('hidden');

            } catch (error) {
                console.error(error);
                showMessage(`è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            } finally {
                setAiLoading(false);
            }
        }

        // æ€»ç»“åŠŸèƒ½
        async function generateStudySummary() {
            if (appData.stats.totalRepetitions === 0) {
                 showMessage("è¯·å…ˆè®°å½•ä¸€äº›å•è¯", 'warning'); return;
            }
            setAiLoading(true);

            // ç®€å•ç»Ÿè®¡å‰3ä¸ªé«˜é¢‘è¯
            const aggregatedStats = appData.repetitions.reduce((acc, item) => {
                const w = item.word.toLowerCase();
                acc[w] = (acc[w] || 0) + 1;
                return acc;
            }, {});
            const topWords = Object.entries(aggregatedStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(entry => `${entry[0]}(${entry[1]})`)
                .join(', ');

            const systemPrompt = "ä½ æ˜¯ä¸€ä½å­¦ä¹ æ•™ç»ƒã€‚æ ¹æ®æ•°æ®ç”Ÿæˆç®€çŸ­é¼“åŠ±æ€§æ€»ç»“å’Œ3æ¡å»ºè®®ã€‚";
            const userQuery = `å¤ä¹ ${appData.stats.totalRepetitions}æ¬¡ï¼Œæ—¶é•¿${appData.stats.totalStudyTimeMinutes}åˆ†ï¼Œå¸¸é”™ï¼š${topWords}`;

            try {
                const text = await callLLM(userQuery, systemPrompt);
                els.llmResponse.innerHTML = `<h3 class="text-lg font-bold mb-2 text-green-700">ğŸ‰ å­¦ä¹ æ€»ç»“</h3><div class="prose text-sm text-gray-700">${(text || "æš‚æ— ").replace(/\n/g, '<br>')}</div>`;
                els.llmResponse.classList.remove('hidden');
            } catch (error) {
                showMessage(`æ€»ç»“å¤±è´¥: ${error.message}`, 'error');
            } finally {
                setAiLoading(false);
            }
        }

        // =================================================================
        // 5. åˆå§‹åŒ–ä¸äº¤äº’ç»‘å®š
        // =================================================================

        function setAiLoading(loading) {
            if (loading) {
                els.defineBtn.disabled = true;
                els.summaryBtn.disabled = true;
                els.llmResponse.classList.add('hidden');
                els.llmResponse.innerHTML = '';
                els.aiLoader.classList.remove('hidden');
            } else {
                els.aiLoader.classList.add('hidden');
                els.defineBtn.disabled = false;
                els.summaryBtn.disabled = false;
            }
        }

        function showMessage(msg, type = 'info') {
            els.messageBox.textContent = msg;
            els.messageBox.classList.remove('hidden');
            let baseClass = 'p-3 text-center text-sm rounded-lg transition-all duration-300 fixed bottom-4 left-1/2 transform -translate-x-1/2 shadow-lg z-50';
            let classMap = {
                'success': ' bg-green-100 text-green-700',
                'error': ' bg-red-100 text-red-700',
                'warning': ' bg-yellow-100 text-yellow-700',
                'info': ' bg-blue-100 text-blue-700'
            };
            els.messageBox.className = baseClass + (classMap[type] || classMap['info']);
            setTimeout(() => { els.messageBox.classList.add('hidden'); }, 3000);
        }

        // Modal Helpers
        function openModal(modal) { modal.classList.add('show'); }
        function closeModal(modal) { modal.classList.remove('show'); }

        // Settings Logic
        function updateSettingsUI() {
            els.apiProvider.value = apiConfig.provider;
            els.apiKeyInput.value = apiConfig.apiKey;
            els.apiBaseUrl.value = apiConfig.baseUrl || '';
            els.apiModelName.value = apiConfig.modelName || '';
            
            if (apiConfig.provider === 'gemini') {
                els.geminiFields.classList.remove('hidden');
                els.openaiFields.classList.add('hidden');
            } else {
                els.geminiFields.classList.add('hidden');
                els.openaiFields.classList.remove('hidden');
            }
        }

        function handleSaveSettings() {
            const provider = els.apiProvider.value;
            const key = els.apiKeyInput.value.trim();
            const url = els.apiBaseUrl.value.trim();
            const model = els.apiModelName.value.trim();

            if (!key) { showMessage("è¯·è¾“å…¥ API Key", "error"); return; }
            if (provider === 'openai' && (!url || !model)) {
                showMessage("OpenAI æ¨¡å¼éœ€è¦ URL å’Œæ¨¡å‹å", "error"); return;
            }

            apiConfig = { 
                provider, 
                apiKey: key, 
                baseUrl: url || apiConfig.baseUrl, // ä¿ç•™é»˜è®¤å€¼å¦‚æœä¸ºç©º
                modelName: model || apiConfig.modelName 
            };
            
            saveConfig();
            closeModal(els.settingsModal);
        }

        function init() {
            loadConfig();
            const lastProfile = localStorage.getItem('wt_last_profile');
            loadData(lastProfile);
            startSessionTimer();

            // Event Listeners
            els.recordBtn.onclick = recordRepetition;
            els.toggleBtn.onclick = () => {
                const active = els.collapse.classList.toggle('active');
                els.toggleText.textContent = active ? 'æŠ˜å æ”¶èµ·' : 'å±•å¼€æŸ¥çœ‹';
                els.toggleIcon.style.transform = active ? 'rotate(180deg)' : 'rotate(0deg)';
            };
            els.defineBtn.onclick = getWordDefinitionAndExamples;
            els.summaryBtn.onclick = generateStudySummary;
            els.resetBtn.onclick = resetData;

            // Auth Modal
            els.authBtn.onclick = () => {
                els.authNameInput.value = '';
                openModal(els.authModal);
                els.authNameInput.focus();
            };
            els.submitAuthBtn.onclick = () => {
                const name = els.authNameInput.value.trim();
                if (name) { loadData(name); showMessage(`å·²åˆ‡æ¢: ${name}`, "success"); closeModal(els.authModal); }
            };

            // Settings Modal
            els.settingsBtn.onclick = () => {
                updateSettingsUI();
                openModal(els.settingsModal);
            };
            els.apiProvider.onchange = () => {
                apiConfig.provider = els.apiProvider.value; // Temporary switch for UI
                updateSettingsUI();
            };
            els.saveSettingsBtn.onclick = handleSaveSettings;

            // Close modals
            document.querySelectorAll('.close-modal-btn').forEach(btn => {
                btn.onclick = (e) => closeModal(e.target.closest('.modal'));
            });

            els.wordInput.onkeydown = (e) => { if (e.key === 'Enter') recordRepetition(); };
            els.authNameInput.onkeydown = (e) => { if (e.key === 'Enter') els.submitAuthBtn.click(); };
        }

        window.onload = init;

    </script>

</body>
</html>